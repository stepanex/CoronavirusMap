<!DOCTYPE html>
<html>
<head>
    <title>Coronavirus in Czech Republic</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
	<meta name="description" content="Coronavirus in Czech Republic">
	<meta name="keywords" content="Coronavirus, Koronamap, Czech, Czechia, Czech Republic">
	<meta name="author" content="Štěpán Štrba">
    <style>
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
            height: 90%;
        }
        #info{
            height: 10%;
            text-align: center;
            font-size: 30px;
            display: table;
            margin: auto;
        }
        #info>div{
            display: table-cell;
            vertical-align: middle;
        }
        /* Optional: Makes the sample page fill the window. */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
			font-family: 'Ubuntu', sans-serif;
        }
    </style>
    <script>
        // This example requires the Places library. Include the libraries=places
        // parameter when you first load the API. For example:
        // <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places">

        var map;
        var service;
        var infowindow;
        var color_green = '#40ff00';
        var color_orange = '#ffbf00';
        var color_red = '#ff0000';
        var color_white = '#ffffff';

        function initMap() {

            var sydney = new google.maps.LatLng(49.8037633, 15.4749126);

            infowindow = new google.maps.InfoWindow();

            map = new google.maps.Map(
                document.getElementById('map'), {center: sydney, zoom: 8});

            service = new google.maps.places.PlacesService(map);
            var placesCor = [];
            var regionsCor = [['Prague',0],['Hradec Králové Region', 0],['Karlovy Vary Region',0],
                ['Liberec Region',0],['Moravian-Silesian Region',0],['Olomouc Region',0],['Pardubice Region',0],
                ['Plzeň Region',0],['Central Bohemian Region', 0],['South Bohemian Region',0],
                ['South Moravian Region',0],['Ústí nad Labem Region',0],['Vysočina Region',0],['Zlín Region',0]];
            console.log('loading wiki');
            fetch('/wikiData/').then(data => data.json()).then(data =>{
                console.log('loaded');
                var html = data.parse.text['*'];
                var htmlDom = new DOMParser().parseFromString(html, "text/xml");

                var cases = htmlDom.getElementsByClassName('wikitable')[0].children[0].children;
                var numberOfCases = cases[cases.length-2].children[0].firstChild.textContent.split('-')[1];
                document.getElementsByName('info')[0].innerText='Počet nakažených: '+ numberOfCases;
                for(let i = 2; i < cases.length;i+=2){

                    let place = cases[i].children[5].firstChild.textContent;
                    let region = cases[i].children[6].firstChild.textContent;
                    let treatment = cases[i].children[7].firstChild.textContent;

                    // let queryPlace = 'Czech Republic';
                    if(place.toString().localeCompare('N/A\n')){
                        let queryPlace = place+', '+region;
                        if(treatment.toString().localeCompare('N/A\n') && treatment.toString().localeCompare('Home isolation\n'))
                            queryPlace = treatment+', '+region;

                        let found = false;
                        for(let j = 0; j<placesCor.length;j++){
                            if(placesCor[j][0] === queryPlace){
                                placesCor[j][1]+=1;
                                found = true;
                                break;
                            }
                        }
                        if(!found){
                            placesCor.push([queryPlace, 1])
                        }
                    }

                    found = false;
                    for(let j = 0; j<regionsCor.length;j++){
                        if(regionsCor[j][0] === region){
                            regionsCor[j][1] += 1;
                            found = true;
                            break;
                        }
                    }
                    if(!found && !region.toString().localeCompare('N/A')){
                        console.log(region);
                        console.log('FUCK#1');
                    }
                }
                }).then(data => {
                    let k = 0;
                    placesCor.forEach(place => {
                        setTimeout(k*5);
                        k++;
                        let request = {
                            query: place[0],
                            fields: ['name', 'geometry'],
                        };

                        let success = false;
                        tries = 0;

                        let intr = setInterval(function() {
                            service.findPlaceFromQuery(request, function(results, status) {
                                if(status === google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT){
                                    console.log(status);
                                    console.log("FUCK");
                                }
                                else if (status === google.maps.places.PlacesServiceStatus.OK) {
                                    if(results.length){
                                        createMarker(results[0], place[1]);
                                    }
                                    success = true;
                                    clearInterval(intr);
                                }
                            });
                            tries++;

                            if (success || (tries > 3)) clearInterval(intr);
                        }, 1000);
                        console.log(place[0]+' '+place[1]);
                    });
                    // Define the LatLng coordinates for the polygon.
                    var prague = [];
                    for(let k = 1; k<15; k++){
                        fetch('./regionPolygons/area'+String("0" + k).slice(-2)+'.txt').then(data => data.json()).then(data =>{
                            let color = color_white;
                            if(regionsCor[k-1][1]<5){
                                color = color_green;
                            } else if(regionsCor[k-1][1] < 20){
                                color = color_orange;
                            } else {
                                color = color_red;
                            }
                            if(k===1){
                                prague = data;
                            }
                            else if (k===9) {
                                data = [data, prague.reverse()];
                            }

                            var bermudaTriangle = new google.maps.Polygon({
                                paths: data,
                                strokeColor: color,
                                strokeOpacity: 0.8,
                                strokeWeight: 3,
                                fillColor: color,
                                fillOpacity: 0.35
                            });
                            bermudaTriangle.setMap(map);

                            google.maps.event.addListener(bermudaTriangle, 'click', function (event) {
                                infowindow.setContent(regionsCor[k - 1][0] + '<br/>Počet nakažených: ' + regionsCor[k - 1][1]);
                                if (event) {
                                    point = event.latLng;
                                }
                                infowindow.setPosition(point);
                                infowindow.open(map);
                            });

                        });
                    }
                }).catch((error) => {
                console.error('Error:', error);
            });

        }

        function createMarker(place, text) {
            var marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location
            });

            google.maps.event.addListener(marker, 'click', function() {
                infowindow.setContent(place.name+'<br/>Počet nakažených: '+text);
                infowindow.open(map, this);
            });
        }
        function createMarker2(location, text) {
            var marker = new google.maps.Marker({
                map: map,
                position: location
            });

            google.maps.event.addListener(marker, 'click', function() {
                infowindow.setContent(location.lat+':'+location.lng);
                infowindow.open(map, this);
            });
        }


    </script>
</head>
<body>
<div id="info"><div name="info">Načítání...</div></div>
<div id="map"></div>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjOMAwQy-SKsAykvXtd3Q2HBsIkEzyvI0&libraries=places&callback=initMap" async defer></script>
</body>
</html>