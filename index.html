<!DOCTYPE html>
<html>
<head>
    <title>Coronavirus in Czech Republic</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
	<meta name="description" content="Coronavirus in Czech Republic">
	<meta name="keywords" content="Coronavirus, Koronamap, Czech, Czechia, Czech Republic">
	<meta name="author" content="Štěpán Štrba">
    <style>
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
            height: 90%;
        }
        #info{
            height: 10%;
            text-align: center;
            font-size: 30px;
            display: table;
            margin: auto;
        }
        #info>div{
            display: table-cell;
            vertical-align: middle;
        }
        /* Optional: Makes the sample page fill the window. */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
			font-family: 'Ubuntu', sans-serif;
            overflow-y:hidden
        }
    </style>
    <script data-ad-client="ca-pub-8503799930198018" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
        // This example requires the Places library. Include the libraries=places
        // parameter when you first load the API. For example:
        // <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places">

        var map;
        var service;
        var infowindow;
        var color_white = '#ffffff';

        var color01 = '#0f9246';
        var color001 = '#7dbb42';
        var color02 = '#ffbf00';
        var color03 = '#f68e1f';
        var color04 = '#ef4723';
        var color05 = '#bc2026';
        var numberOfCases = '0';

        document.addEventListener("DOMContentLoaded", function(event) {
            let intr = setInterval(function() {
               if(numberOfCases !== '0'){
                   document.getElementById('count').innerText='Počet nakažených: '+ numberOfCases;
                   clearInterval(intr);
               }
            },500);
        });

        function initMap() {

            var sydney = new google.maps.LatLng(49.8037633, 15.4749126);

            infowindow = new google.maps.InfoWindow();
            let zoom = Math.log(window.innerWidth/5)/Math.log(2);
            let czechHeight = Math.pow(2,zoom)*2.5;
            let mapHeight = (window.innerHeight/100)*90;
            if(mapHeight < czechHeight){
                zoom = Math.log(mapHeight/3)/Math.log(2);
            }

            map = new google.maps.Map(
                document.getElementById('map'), {center: sydney, zoom: zoom});

            service = new google.maps.places.PlacesService(map);
            var placesToPrint = [];
            var regionsCor = [['Praha',0],['Královéhradecký kraj', 0],['Karlovarský kraj',0],
                ['Liberecký kraj',0],['Moravskoslezský kraj',0],['Olomoucký kraj',0],['Pardubický kraj',0],
                ['Plzeňský kraj',0],['Středočeský kraj', 0],['Jihočeský kraj',0],
                ['Jihomoravský kraj',0],['Ústecký kraj',0],['Kraj Vysočina',0],['Zlínský kraj',0]];
            var regionsPopulation = [['Praha',1308632],['Královéhradecký kraj', 551021],['Karlovarský kraj',294896],
                ['Liberecký kraj',442356],['Moravskoslezský kraj',1203299],['Olomoucký kraj',632492],['Pardubický kraj',520316],
                ['Plzeňský kraj',584672],['Středočeský kraj', 1369332],['Jihočeský kraj',642133],
                ['Jihomoravský kraj',1187667],['Ústecký kraj',820789],['Kraj Vysočina',509274],['Zlínský kraj',582921]];
            console.log('loading wiki');
            fetch('/wikiData/').then(data => data.json()).then(data =>{
                console.log('loaded');
                var html = data.parse.text['*'];
                var htmlDom = new DOMParser().parseFromString(html, "text/xml");

                var cases = htmlDom.getElementsByClassName('wikitable')[0].children[0].children;
                var numberOfCasesOrigin = cases[cases.length-2].children[0].firstChild.textContent;
                if(numberOfCasesOrigin.includes('–')){
                    let numberOfCasesSplitted = numberOfCasesOrigin.split('–');
                    numberOfCases = numberOfCasesSplitted[numberOfCasesSplitted.length-1];
                }
                else if(numberOfCasesOrigin.includes('-')){
                    let numberOfCasesSplitted = numberOfCasesOrigin.split('-');
                    numberOfCases = numberOfCasesSplitted[numberOfCasesSplitted.length-1];
                }
                for(let i = 2; i < cases.length;i+=2){

                    let state = cases[i].children[2].firstChild.textContent;
                    if(state.toString().localeCompare('nepotvrzeno\n')===0){
                        continue;
                    }

                    let caseNumber = cases[i].children[0].firstChild.textContent.toString();
                    let countOfCases = 1;
                    if(caseNumber.includes('–')){
                        let caseNumberSplitted = caseNumber.split('–');
                        countOfCases = parseInt(caseNumberSplitted[1]) - parseInt(caseNumberSplitted[0]) + 1;
                    }
                    else if(caseNumber.includes('-')){
                        let caseNumberSplitted = caseNumber.split('-');
                        countOfCases = parseInt(caseNumberSplitted[1]) - parseInt(caseNumberSplitted[0]) + 1;
                    }

                    let place = cases[i].children[5].firstChild.textContent.split(',')[0].split(['\n'])[0];
                    let region = cases[i].children[6].firstChild.textContent.split(',')[0].split(['\n'])[0];
                    let treatment = cases[i].children[7].firstChild.textContent.split(',')[0].split(['\n'])[0];

                    let found = false;
                    let queryPlace = '';
                    if(place.toString().localeCompare('N/A') && place.toString().localeCompare('Praha') ||
                        (treatment.toString().localeCompare('N/A') && treatment.toString().localeCompare('domácí izolace'))){
                        if(treatment.toString().localeCompare('N/A') && treatment.toString().localeCompare('domácí izolace')){
                            queryPlace = treatment;
                        } else {
                            queryPlace = place;
                        }

                        for(let j = 0; j<placesToPrint.length;j++){
                            if(placesToPrint[j][0] === queryPlace){
                                placesToPrint[j][1]+=countOfCases;
                                found = true;
                                break;
                            }
                        }
                        if(!found){
                            placesToPrint.push([queryPlace, 1])
                        }
                    }

                    if(region.toString().localeCompare('N/A')){
                        found = false;
                        for(let j = 0; j<regionsCor.length;j++){
                            if(regionsCor[j][0] === region){
                                regionsCor[j][1] += countOfCases;
                                found = true;
                                break;
                            }
                        }
                        if(!found){
                            console.log(region);
                            console.log('FUCK#1');
                        }
                    }
                }
                }).then(data => {
                    let k = 0;
                    placesToPrint.forEach(place => {
                        setTimeout(k*5);
                        k++;

                        let data = new FormData();
                        data.append('type','findPlace');
                        data.append('searchName',place[0]);
                        var origin = 'http://koronamap.cz';
                        fetch('/api.php', {
                            method: 'post',
                            body: data,
                            origin: origin
                        }).then(response => response.json()).then(response => {
                            if(response[0] === 1 && response[1] !== null){
                                let latitude = JSON.parse(response[1]['location'])[0];
                                let longtitude = JSON.parse(response[1]['location'])[1];
                                let name = response[1]['name'];
                                let latlng = {lat: latitude, lng: longtitude};
                                createMarkerLatlng(latlng, name, place[1]);
                            } else {
                                let request = {
                                    query: place[0],
                                    fields: ['name', 'geometry'],
                                };

                                let success = false;
                                let tries = 0;

                                let intr = setInterval(function() {
                                    service.findPlaceFromQuery(request, function(results, status) {
                                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                                            if(results.length){
                                                let foundPlace = results[0];

                                                let latlng = [];
                                                latlng.push(foundPlace['geometry']['location'].lat());
                                                latlng.push(foundPlace['geometry']['location'].lng());
                                                let data = new FormData();
                                                data.append('type','insertPlace');
                                                data.append('name',foundPlace['name']);
                                                data.append('searchName',place[0]);
                                                data.append('location',JSON.stringify(latlng));
                                                fetch('/api.php', {
                                                    method: 'post',
                                                    body: data,
                                                    origin: origin
                                                }).then(response => response.json()).then(response => {console.log(response)});

                                                createMarkerGplace(results[0], place[1]);
                                            }
                                            success = true;
                                            clearInterval(intr);
                                        } else {
                                            console.log(status);
                                            console.log("FUCK");
                                        }
                                    });
                                    tries++;

                                    if (success || (tries > 3)) clearInterval(intr);
                                }, 1000);
                            }
                        });


                        console.log(place[0]+' '+place[1]);
                    });
                    // Define the LatLng coordinates for the polygon.
                    var prague = [];
                    for(let k = 1; k<15; k++){
                        fetch('./regionPolygons/area'+String("0" + k).slice(-2)+'.txt').then(data => data.json()).then(data =>{

                            let percent = ((regionsCor[k-1][1])/regionsPopulation[k-1][1])*100;
                            let color = color_white;
                            if(regionsCor[k-1][1]<1){
                                color = color01;
                            } else if(percent < 0.001){
                                color = color001;
                            } else if(percent < 0.01){
                                color = color02;
                            } else if(percent < 0.03){
                                color = color03;
                            } else if(percent < 0.07){
                                color = color04;
                            } else {
                                color = color05;
                            }

                            if(k===1){
                                prague = data;
                            }
                            else if (k===9) {
                                data = [data, prague.reverse()];
                            }

                            var bermudaTriangle = new google.maps.Polygon({
                                paths: data,
                                strokeColor: color,
                                strokeOpacity: 0.8,
                                strokeWeight: 3,
                                fillColor: color,
                                fillOpacity: 0.5
                            });
                            bermudaTriangle.setMap(map);

                            google.maps.event.addListener(bermudaTriangle, 'click', function (event) {
                                infowindow.setContent(regionsCor[k - 1][0] + '<br/>Počet nakažených: ' + regionsCor[k - 1][1]);
                                if (event) {
                                    point = event.latLng;
                                }
                                infowindow.setPosition(point);
                                infowindow.open(map);
                            });

                        });
                    }
                }).catch((error) => {
                console.error('Error:', error);
            });

        }

        function createMarkerLatlng(latlng, name, text) {
            var marker = new google.maps.Marker({
                map: map,
                position: latlng
            });

            google.maps.event.addListener(marker, 'click', function() {
                infowindow.setContent(name+'<br/>Počet nakažených: '+text);
                infowindow.open(map, this);
            });
        }function createMarkerGplace(place, text) {
            var marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location
            });

            google.maps.event.addListener(marker, 'click', function() {
                infowindow.setContent(place.name+'<br/>Počet nakažených: '+text);
                infowindow.open(map, this);
            });
        }
        function createMarker2(location, text) {
            var marker = new google.maps.Marker({
                map: map,
                position: location
            });

            google.maps.event.addListener(marker, 'click', function() {
                infowindow.setContent(location.lat+':'+location.lng);
                infowindow.open(map, this);
            });
        }


    </script>
</head>
<body>
<div id="info">
    <div id="count">Načítání...</div>
</div>
<div id="map"></div>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjOMAwQy-SKsAykvXtd3Q2HBsIkEzyvI0&libraries=places&callback=initMap" async defer></script>
</body>
</html>